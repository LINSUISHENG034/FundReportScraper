# 基金报告自动化采集与分析平台 - 运维手册

## 目录

1. [系统概述](#系统概述)
2. [部署指南](#部署指南)
3. [配置管理](#配置管理)
4. [监控与日志](#监控与日志)
5. [备份与恢复](#备份与恢复)
6. [性能优化](#性能优化)
7. [故障排查](#故障排查)
8. [安全管理](#安全管理)
9. [维护任务](#维护任务)
10. [升级指南](#升级指南)

---

## 系统概述

基金报告自动化采集与分析平台是一个基于Python和FastAPI的微服务架构系统，用于自动化采集、解析和分析公募基金报告数据。

### 核心组件

- **FastAPI Web服务**: 提供REST API接口
- **Celery Worker**: 异步任务处理
- **Celery Beat**: 定时任务调度
- **PostgreSQL**: 关系型数据库
- **Redis**: 缓存和任务队列
- **MinIO**: 对象存储服务
- **Nginx**: 反向代理（可选）

### 系统架构

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Nginx     │───▶│  FastAPI    │───▶│ PostgreSQL  │
│ (反向代理)   │    │  (Web API)  │    │   (数据库)   │
└─────────────┘    └─────────────┘    └─────────────┘
                           │
                   ┌─────────────┐    ┌─────────────┐
                   │   Redis     │───▶│   MinIO     │
                   │ (队列/缓存)  │    │ (对象存储)   │
                   └─────────────┘    └─────────────┘
                           │
                   ┌─────────────┐
                   │   Celery    │
                   │ (任务处理)   │
                   └─────────────┘
```

---

## 部署指南

### 前置要求

- **操作系统**: Ubuntu 20.04+ / CentOS 7+ / RHEL 8+
- **Docker**: 20.10+
- **Docker Compose**: 1.29+
- **内存**: 最小4GB，推荐8GB+
- **存储**: 最小50GB，推荐200GB+
- **网络**: 稳定的互联网连接

### 快速部署

#### 1. 获取代码

```bash
git clone <repository-url>
cd FundReportScraper
```

#### 2. 环境配置

```bash
# 复制生产环境配置模板
cp .env.prod.template .env.prod

# 编辑配置文件
vim .env.prod
```

**必需配置项**:
```bash
# 数据库配置
POSTGRES_PASSWORD=your_secure_password_here
POSTGRES_USER=funduser_prod
POSTGRES_DB=fundreport_prod

# Redis配置
REDIS_PASSWORD=your_redis_password_here

# MinIO配置
MINIO_ACCESS_KEY=your_minio_access_key
MINIO_SECRET_KEY=your_minio_secret_key

# 应用配置
SECRET_KEY=your_super_secure_secret_key_here
```

#### 3. 启动服务

```bash
# 启动所有服务
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d

# 检查服务状态
docker-compose -f docker-compose.prod.yml ps
```

#### 4. 初始化数据库

```bash
# 运行数据库迁移
docker-compose -f docker-compose.prod.yml exec api alembic upgrade head

# 验证数据库连接
docker-compose -f docker-compose.prod.yml exec api python -c "from src.models.connection import get_db_session; next(get_db_session())"
```

#### 5. 验证部署

```bash
# 检查API健康状态
curl http://localhost:8000/health

# 检查API文档
curl http://localhost:8000/docs
```

### 高级部署配置

#### SSL/TLS配置

1. 准备SSL证书
```bash
mkdir -p deploy/nginx/ssl
# 将证书文件放入 deploy/nginx/ssl/ 目录
```

2. 配置Nginx
```bash
# 编辑nginx配置
vim deploy/nginx/nginx.conf
```

3. 启用HTTPS
```bash
# 在docker-compose.prod.yml中取消nginx服务的注释
docker-compose -f docker-compose.prod.yml up -d nginx
```

#### 数据库集群配置

对于高可用部署，建议使用外部PostgreSQL集群：

```bash
# 修改.env.prod中的数据库连接
DATABASE_URL=postgresql://user:pass@db-cluster-endpoint:5432/dbname
```

---

## 配置管理

### 环境变量配置

所有配置通过环境变量管理，配置文件位置：

- **开发环境**: `.env`
- **生产环境**: `.env.prod`
- **测试环境**: `.env.test`

### 核心配置项

#### 数据库配置
```bash
DATABASE_URL=postgresql://user:password@host:port/database
POSTGRES_DB=fundreport_prod
POSTGRES_USER=funduser_prod
POSTGRES_PASSWORD=secure_password
POSTGRES_PORT=5432
```

#### Redis配置
```bash
REDIS_URL=redis://:password@host:port/db
REDIS_PASSWORD=secure_redis_password
REDIS_PORT=6379
```

#### MinIO配置
```bash
MINIO_ENDPOINT=minio:9000
MINIO_ACCESS_KEY=minio_access_key
MINIO_SECRET_KEY=minio_secret_key
MINIO_BUCKET_NAME=fund-reports-prod
MINIO_SECURE=false
```

#### 应用配置
```bash
APP_ENV=production
DEBUG=false
LOG_LEVEL=INFO
SECRET_KEY=your_secret_key
API_PORT=8000
```

#### 爬虫配置
```bash
TARGET_BASE_URL=https://www.eid.csrc.gov.cn
REQUEST_TIMEOUT=30
RATE_LIMIT_MAX_TOKENS=60
RATE_LIMIT_REFILL_RATE=1.0
```

### 配置热更新

大部分配置需要重启服务生效：

```bash
# 重启特定服务
docker-compose -f docker-compose.prod.yml restart api

# 重启所有服务
docker-compose -f docker-compose.prod.yml restart
```

---

## 监控与日志

### 日志管理

#### 日志位置
- **应用日志**: `./logs/`
- **容器日志**: `docker logs <container_name>`

#### 日志级别
- **DEBUG**: 详细调试信息
- **INFO**: 关键业务流程
- **WARNING**: 可恢复的异常
- **ERROR**: 严重错误

#### 查看日志
```bash
# 查看API日志
docker-compose -f docker-compose.prod.yml logs -f api

# 查看Celery Worker日志
docker-compose -f docker-compose.prod.yml logs -f celery_worker

# 查看所有服务日志
docker-compose -f docker-compose.prod.yml logs -f
```

#### 日志轮转配置
```bash
# 配置Docker日志轮转
# 在docker-compose.prod.yml中添加：
services:
  api:
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

### 系统监控

#### 健康检查
```bash
# API健康检查
curl http://localhost:8000/health

# 数据库连接检查
docker-compose -f docker-compose.prod.yml exec postgres pg_isready

# Redis连接检查
docker-compose -f docker-compose.prod.yml exec redis redis-cli ping
```

#### 性能监控
```bash
# 容器资源使用情况
docker stats

# 磁盘使用情况
df -h

# 内存使用情况
free -h

# 系统负载
top
```

#### 数据库监控
```bash
# 连接数监控
docker-compose -f docker-compose.prod.yml exec postgres psql -U $POSTGRES_USER -d $POSTGRES_DB -c "SELECT count(*) FROM pg_stat_activity;"

# 数据库大小
docker-compose -f docker-compose.prod.yml exec postgres psql -U $POSTGRES_USER -d $POSTGRES_DB -c "SELECT pg_size_pretty(pg_database_size('$POSTGRES_DB'));"
```

---

## 备份与恢复

### 数据库备份

#### 自动备份脚本
```bash
#!/bin/bash
# backup_database.sh

BACKUP_DIR="/backups/postgres"
BACKUP_FILE="fundreport_$(date +%Y%m%d_%H%M%S).sql"

mkdir -p $BACKUP_DIR

docker-compose -f docker-compose.prod.yml exec -T postgres pg_dump -U $POSTGRES_USER $POSTGRES_DB > $BACKUP_DIR/$BACKUP_FILE

# 压缩备份文件
gzip $BACKUP_DIR/$BACKUP_FILE

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "Database backup completed: $BACKUP_FILE.gz"
```

#### 设置定时备份
```bash
# 添加到crontab
crontab -e

# 每天凌晨2点备份
0 2 * * * /path/to/backup_database.sh
```

### MinIO备份

#### 数据同步
```bash
# 使用mc工具同步到远程存储
mc mirror minio/fund-reports-prod s3/backup-bucket/fund-reports/
```

### 数据恢复

#### 数据库恢复
```bash
# 停止服务
docker-compose -f docker-compose.prod.yml stop api celery_worker celery_beat

# 恢复数据库
gunzip < /backups/postgres/fundreport_20240101_020000.sql.gz | \
docker-compose -f docker-compose.prod.yml exec -T postgres psql -U $POSTGRES_USER $POSTGRES_DB

# 重启服务
docker-compose -f docker-compose.prod.yml start api celery_worker celery_beat
```

#### MinIO恢复
```bash
# 从备份恢复MinIO数据
mc mirror s3/backup-bucket/fund-reports/ minio/fund-reports-prod
```

---

## 性能优化

### 数据库优化

#### 索引优化
```sql
-- 为常用查询创建索引
CREATE INDEX CONCURRENTLY idx_fund_reports_fund_code_date ON fund_reports(fund_code, report_date DESC);
CREATE INDEX CONCURRENTLY idx_fund_reports_type_date ON fund_reports(report_type, report_date DESC);
```

#### 连接池配置
```bash
# 在.env.prod中配置
DATABASE_POOL_SIZE=10
DATABASE_MAX_OVERFLOW=20
```

### Redis优化

#### 内存优化
```bash
# redis.conf配置
maxmemory 2gb
maxmemory-policy allkeys-lru
```

### 应用优化

#### Celery配置
```bash
# worker并发数
CELERY_WORKER_CONCURRENCY=4

# 任务预取数量
CELERY_WORKER_PREFETCH_MULTIPLIER=1

# 任务超时时间
CELERY_TASK_SOFT_TIME_LIMIT=300
CELERY_TASK_TIME_LIMIT=600
```

#### FastAPI优化
```bash
# 启用HTTP/2
# 在nginx配置中添加
listen 443 ssl http2;
```

---

## 故障排查

### 常见问题

#### 1. API服务无法启动

**症状**: API容器启动失败或健康检查失败

**排查步骤**:
```bash
# 查看容器日志
docker-compose -f docker-compose.prod.yml logs api

# 检查配置文件
docker-compose -f docker-compose.prod.yml config

# 检查端口占用
netstat -tlnp | grep 8000
```

**解决方案**:
- 检查环境变量配置
- 确认数据库连接正常
- 检查端口冲突

#### 2. 数据库连接失败

**症状**: 应用无法连接到PostgreSQL

**排查步骤**:
```bash
# 检查PostgreSQL容器状态
docker-compose -f docker-compose.prod.yml ps postgres

# 测试数据库连接
docker-compose -f docker-compose.prod.yml exec postgres pg_isready

# 检查网络连接
docker-compose -f docker-compose.prod.yml exec api ping postgres
```

#### 3. Celery任务不执行

**症状**: 任务提交到队列但不被处理

**排查步骤**:
```bash
# 检查Celery Worker状态
docker-compose -f docker-compose.prod.yml logs celery_worker

# 检查Redis连接
docker-compose -f docker-compose.prod.yml exec redis redis-cli ping

# 查看任务队列
docker-compose -f docker-compose.prod.yml exec redis redis-cli llen celery
```

#### 4. MinIO存储问题

**症状**: 文件上传失败或无法访问

**排查步骤**:
```bash
# 检查MinIO服务状态
docker-compose -f docker-compose.prod.yml logs minio

# 测试MinIO连接
curl http://localhost:9000/minio/health/live

# 检查存储空间
docker-compose -f docker-compose.prod.yml exec minio df -h
```

### 性能问题排查

#### 1. 高CPU使用率
```bash
# 查看容器CPU使用情况
docker stats

# 查看进程CPU使用
docker-compose -f docker-compose.prod.yml exec api top
```

#### 2. 内存泄漏
```bash
# 监控内存使用
docker stats --format "table {{.Container}}\t{{.MemUsage}}\t{{.MemPerc}}"

# 分析内存使用详情
docker-compose -f docker-compose.prod.yml exec api cat /proc/meminfo
```

#### 3. 数据库性能问题
```sql
-- 查看慢查询
SELECT query, mean_time, calls 
FROM pg_stat_statements 
ORDER BY mean_time DESC 
LIMIT 10;

-- 查看锁等待
SELECT * FROM pg_stat_activity WHERE wait_event IS NOT NULL;
```

---

## 安全管理

### 访问控制

#### 1. 网络安全
```bash
# 限制端口访问
# 在防火墙中只开放必要端口
ufw allow 80/tcp
ufw allow 443/tcp
ufw deny 5432/tcp  # 数据库端口不对外开放
```

#### 2. 容器安全
```bash
# 使用非root用户运行容器
# 已在Dockerfile.prod中配置

# 定期更新基础镜像
docker pull python:3.10-slim
docker-compose -f docker-compose.prod.yml build --no-cache
```

### 密钥管理

#### 1. 环境变量加密
```bash
# 使用工具加密敏感配置
# 建议使用Ansible Vault或类似工具管理生产密钥
```

#### 2. 证书管理
```bash
# SSL证书定期更新
# 建议使用Let's Encrypt自动化证书管理
certbot renew --dry-run
```

### 安全监控

#### 1. 日志监控
```bash
# 监控异常登录尝试
grep "401\|403\|failed" /var/log/nginx/access.log

# 监控系统入侵迹象
fail2ban-client status
```

#### 2. 漏洞扫描
```bash
# 定期扫描容器漏洞
docker scout quickview
```

---

## 维护任务

### 日常维护

#### 1. 系统检查清单（每日）
- [ ] 检查所有服务运行状态
- [ ] 查看系统资源使用情况
- [ ] 检查错误日志
- [ ] 验证数据采集任务正常运行

```bash
#!/bin/bash
# daily_check.sh
echo "=== 每日系统检查 ==="
echo "1. 服务状态检查"
docker-compose -f docker-compose.prod.yml ps

echo "2. 系统资源检查"
free -h
df -h

echo "3. 健康检查"
curl -s http://localhost:8000/health | jq .

echo "4. 错误日志检查"
docker-compose -f docker-compose.prod.yml logs --since 24h | grep -i error | wc -l
```

#### 2. 周度维护任务
- [ ] 清理过期日志文件
- [ ] 检查数据库性能指标
- [ ] 更新系统补丁
- [ ] 验证备份文件完整性

#### 3. 月度维护任务
- [ ] 数据库维护（VACUUM, ANALYZE）
- [ ] 清理旧版本Docker镜像
- [ ] 安全扫描和漏洞修复
- [ ] 性能报告生成

### 数据库维护

#### 1. 定期维护脚本
```sql
-- database_maintenance.sql
-- 更新统计信息
ANALYZE;

-- 清理死锁
VACUUM;

-- 重建索引（根据需要）
REINDEX DATABASE fundreport_prod;
```

#### 2. 数据清理
```sql
-- 清理过期的任务记录（保留30天）
DELETE FROM task_history 
WHERE created_at < NOW() - INTERVAL '30 days';

-- 清理过期的日志记录（保留90天）
DELETE FROM application_logs 
WHERE created_at < NOW() - INTERVAL '90 days';
```

---

## 升级指南

### 应用升级流程

#### 1. 准备工作
```bash
# 创建系统快照/备份
./backup_database.sh

# 拉取最新代码
git fetch origin
git checkout v1.1.0  # 替换为目标版本
```

#### 2. 升级步骤
```bash
# 停止服务
docker-compose -f docker-compose.prod.yml stop

# 构建新镜像
docker-compose -f docker-compose.prod.yml build

# 运行数据库迁移
docker-compose -f docker-compose.prod.yml run --rm api alembic upgrade head

# 启动服务
docker-compose -f docker-compose.prod.yml up -d

# 验证升级
curl http://localhost:8000/health
```

#### 3. 回滚计划
```bash
# 如果升级失败，执行回滚
docker-compose -f docker-compose.prod.yml stop

# 恢复之前版本
git checkout v1.0.0

# 恢复数据库（如有必要）
gunzip < /backups/postgres/pre_upgrade_backup.sql.gz | \
docker-compose -f docker-compose.prod.yml exec -T postgres psql -U $POSTGRES_USER $POSTGRES_DB

# 重新启动服务
docker-compose -f docker-compose.prod.yml up -d
```

### 配置文件更新

在升级过程中，注意检查配置文件变更：

1. 比较新旧配置模板
2. 更新环境变量
3. 更新Docker Compose文件
4. 验证配置兼容性

---

## 联系信息

### 技术支持

- **开发团队**: dev-team@company.com
- **运维团队**: ops-team@company.com
- **紧急联系**: emergency@company.com

### 文档版本

- **文档版本**: v1.0.0
- **最后更新**: 2025-07-12
- **适用系统版本**: v1.0.0+

---

*本文档将根据系统升级和运维经验持续更新。如有问题或建议，请联系技术团队。*