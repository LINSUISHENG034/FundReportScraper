# 项目重构计划 (Project Refactoring Plan)

**版本**: 1.0
**日期**: 2025-07-15
**负责人**: 技术架构师

## 1. 背景与目标

当前项目在前期快速迭代后，虽已实现核心功能（XBRL报告下载、解析），但存在代码结构混乱、模块职责不清、日志系统缺失、测试覆盖率不足以及命名不规范（如`reports_v2`）等问题。这些问题已成为后续开发和维护的瓶颈。

本次重构旨在解决上述问题，核心目标如下：

1.  **架构清晰化**: 重新组织项目结构，确保各模块遵循单一职责原则。
2.  **日志规范化**: 全面集成 `structlog` 实现结构化、可追溯的日志记录，并统一输出到 `logs/` 目录。
3.  **测试驱动重构**: 大规模集成 `pytest`，为核心模块编写单元测试和集成测试，确保重构过程的稳定性和代码质量。
4.  **代码整洁化**: 移除无意义的命名（如 "V2"），统一代码风格，提升代码可读性。

## 2. 重构阶段与任务分解

本次重构将分为四个主要阶段，循序渐进，每个阶段结束时都应有可验证的成果。

---

### **阶段一：基础建设与环境准备 (Infrastructure Setup)**

**目标**: 搭建支持重构的日志和测试框架。

*   **任务 1.1: 配置 `structlog`**
    *   **描述**: 在 `src/core/logging.py` 中配置 `structlog`。
    *   **验收标准**:
        *   所有日志输出为 JSON 格式。
        *   日志包含时间戳、日志级别、logger名称和具体消息。
        *   开发环境中，日志可读性强（控制台输出）；生产环境中，日志格式为纯 JSON。
        *   所有日志文件按日期轮转，统一存储在项目根目录的 `logs/` 文件夹下。
        *   全局禁用 `print()` 语句，替换为 `structlog` 调用。

*   **任务 1.2: 配置 `pytest`**
    *   **描述**: 配置 `pytest` 测试环境，并为 FastAPI 应用创建测试客户端。
    *   **验收标准**:
        *   在 `pyproject.toml` 或 `pytest.ini` 中完成基本配置。
        *   在 `tests/conftest.py` 中创建可复用的 `TestClient` fixture。
        *   创建数据库会话 (Session) 的 mock fixture，用于隔离测试与数据库。
        *   编写一个简单的冒烟测试 (`tests/unit/test_smoke.py`)，确保测试环境可以正常运行并成功启动 FastAPI 应用。

---

### **阶段二：核心服务层重构与单元测试 (Core Services Refactoring)**

**目标**: 对核心业务逻辑（服务、抓取器、解析器）进行重构，并达到80%以上的单元测试覆盖率。

*   **任务 2.1: 重构 `services` 模块**
    *   **描述**: 逐一重构 `src/services/` 下的每个服务文件。
    *   **验收标准**:
        *   为 `fund_report_service` 等核心服务编写全面的单元测试，测试所有公共方法。
        *   在服务逻辑中，使用 `structlog` 替换所有旧的日志记录方式。
        *   确保服务层不直接依赖 FastAPI 的请求/响应对象，实现与API层的解耦。
        *   测试覆盖率报告显示 `src/services/` 目录达到80%+。

*   **任务 2.2: 重构 `scrapers` 和 `parsers` 模块**
    *   **描述**: 重构数据抓取和解析模块。
    *   **验收标准**:
        *   为 `csrc_fund_scraper` 和 `xbrl_parser` 编写单元测试。
        *   对外部HTTP请求和文件系统操作进行 mock。
        *   所有日志记录通过 `structlog` 实现。

---

### **阶段三：API 接口层重构与集成测试 (API Layer Refactoring)**

**目标**: 清理 API 路由，优化接口定义，并编写集成测试。

*   **任务 3.1: 移除 "V2" 命名**
    *   **描述**: 将 `src/api/routes/reports_v2.py` 重命名为 `src/api/routes/reports.py`。
    *   **验收标准**:
        *   文件名已更改。
        *   FastAPI 应用��引用的路由已更新，确保 API 正常注册。
        *   相关的 API 文档（Swagger/OpenAPI）中不再出现 "v2" 字样。

*   **任务 3.2: 编写 API 集成测试**
    *   **描述**: 使用 `pytest` 和 `TestClient` 为 `reports.py` 和 `downloads.py` 中的每个API端点编写集成测试。
    *   **验收标准**:
        *   测试覆盖所有API端点的成功场景（200 OK）和主要失败场景（4xx/5xx）。
        *   测试验证请求参数、响应体结构和状态码是否符合预期。
        *   集成测试会调用到重构后的真实服务层（但会 mock 掉最底层的外部依赖，如数据库和HTTP请求）。

---

### **阶段四：最终审查与清理 (Final Review & Cleanup)**

**目标**: 确保项目整洁、一致，并更新文档。

*   **任务 4.1: 全局代码审查与格式化**
    *   **描述**: 对整个 `src` 和 `tests` 目录运行代码质量工具。
    *   **验收标准**:
        *   运行 `poetry run black .` 进行代码格式化。
        *   运行 `poetry run flake8 src tests` 确保没有 linting 错误。
        *   运行 `poetry run pytest --cov=src` 确保所有测试通过，并检查最终的测试覆盖率。

*   **任务 4.2: 文档更新**
    *   **描述**: 更新项目文档以反映新的架构和工作流程。
    *   **验收标准**:
        *   更新 `README.md` 中的开发和测试命令。
        *   如有必要，更新 `docs/` 目录下的其他相关技术文档。

*   **任务 4.3: 清理遗留文件**
    *   **描述**: 删除在重构过程中产生的任何废弃、未使用或重复的代码文件。
    *   **验收标准**:
        *   项目目录中不存在无用的 `.py` 或其他配置文件。

## 3. 风险与应对

*   **风险**: 重构过程中可能引入新 Bug。
    *   **应对**: 严格执行测试驱动的重构流程。每个小步骤修改后都必须运行相关测试，确保现有功能不被破坏。
*   **风险**: 重构耗时可能超出预期。
    *   **应对**: 严格遵循分阶段计划，确保每个阶段都有明确的可交付成果。如果时间紧张，优先完成核心模块的重构和测试。